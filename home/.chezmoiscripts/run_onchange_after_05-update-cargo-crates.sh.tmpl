#!/usr/bin/env bash

set -euo pipefail

if rustup default &>/dev/null; then
    echo "Rust toolchain is already installed"
else
    echo "Installing Rust toolchain using rustup"
    rustup default stable
fi

# Track general asdf plugins and tool versions changes
# {{ include "readonly_dot_tool-versions.tmpl" | sha256sum }}
# {{ include "asdf_plugins.tmpl" | sha256sum }}

# This script installs cargo crates from the default-cargo-crates file
# {{ include "readonly_dot_default-cargo-crates" | sha256sum }}

cargo_crates_file={{ joinPath .chezmoi.sourceDir "readonly_dot_default-cargo-crates" | quote }}

if [[ ! -f "$cargo_crates_file" ]]; then
    echo "Error: default-cargo-crates file not found at $cargo_crates_file"
    exit 1
fi

# Read the file content into an array
if ! mapfile -t lines < "$cargo_crates_file"; then
    echo "Error: Failed to read default-cargo-crates file"
    exit 1
fi

# Get list of installed cargo binaries once
declare -a installed_crates
while IFS= read -r line; do
    [[ -z "$line" ]] && continue
    crate_name=$(echo "$line" | sed 's/ .*//')
    [[ -n "$crate_name" ]] && installed_crates+=("$crate_name")
done < <(cargo install --list)

# Check if a crate is already installed (in-memory lookup)
is_crate_installed() {
    local crate_name=$1
    [[ " ${installed_crates[@]} " =~ " ${crate_name} " ]]
}

# install cargo crate.
#
# Handles both regular crates and --git format
# ex: install_crate crate_name
# ex: install_crate --git https://github.com/user/repo.git crate_name
install_crate() {
    local args=("$@")
    local crate_name="${args[-1]}"  # Last arg is always the crate name

    if is_crate_installed "$crate_name"; then
        echo "Crate $crate_name is already installed, skipping"
        return 0
    fi

    echo "Installing crate: $crate_name"
    if ! cargo install "${args[@]}"; then
        echo "Regular install failed, trying with --locked option"
        if ! cargo install --locked "${args[@]}"; then
            echo "Error: Failed to install crate $crate_name"
            return 1
        fi
    fi
    return 0
}

# Get list of installed cargo binaries
get_installed_binaries() {
    cargo install --list | sed -n 's/^\([^ ]*\) .*/\1/p' | grep -v '^$' | sort || true
}

# Track which crates should be installed
declare -a desired_crates
for line in "${lines[@]}"; do
    # Skip empty lines and comments
    [[ -z "$line" || "$line" =~ ^\s*# ]] && continue
    
    # Extract crate name (last word)
    crate_name="${line##* }"
    desired_crates+=("$crate_name")
    
    # Install the crate (handles both regular and --git formats)
    install_crate $line
done

# Uninstall crates that are no longer in the config
echo ""
echo "Cleaning up unused crates..."
installed_binaries=$(get_installed_binaries)
while IFS= read -r binary; do
    [[ -z "$binary" ]] && continue
    if [[ ! " ${desired_crates[@]} " =~ " ${binary} " ]]; then
        echo "Uninstalling unused crate: $binary"
        cargo uninstall "$binary" || true
    fi
done <<< "$installed_binaries"

# make it available in the current shell
asdf reshim rust

echo "All cargo crates installed successfully"
