[alias]
  # Basic operations
  s = status -sb
  p = push
  f = fetch -ptf

  # Diff and show operations
  icdiff = difftool --no-prompt
  ddiff = -c diff.external=icdiff diff
  dshow = -c diff.external=icdiff show --ext-diff
  dlog  = -c diff.external=icdiff log -p --ext-diff
  # Shows changed files compared to N commits ago
  df = "!f() { git diff --name-status -r "HEAD~$1"; }; f"

  # Pull operations
  pur = pull --rebase
  pup = pull --rebase upstream $(git branch --show-current)

  # Log and history viewing
  # Shows all non-merge commits in one line format
  overview = "!git log --all --oneline --no-merges"
  # Shows your commits since midnight
  recap = "!git log --all --oneline --no-merges --author=$(git config --get user.email) --since=00:00:00"
  today = "!git log --all --oneline --no-merges --author=$(git config --get user.email) --since=00:00:00"
  # Detailed graph view with commit stats and ISO dates
  graph = "!git log --all --graph --decorate --stat --date=iso"
  # Pretty formatted log with colors, limited to 15 entries
  l = !git --no-pager log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr)%C(bold blue) <%an>%Creset' -15
  ll = !git l --all --branches
  # Shows detailed file changes for last commit
  lf = "!git --no-pager log --pretty=format:'%C(yellow)%h%Cred%d\\ %Creset%s%Cblue\\ [%cn]' --decorate --numstat -1"

  # Show operations
  # Detailed commit info display
  shw = show --pretty=format:'hash:    %C(green)%h%C(reset) %nparent:  %C(red)%p%C(reset)%nref:     %C(yellow)%D%C(reset)%nauthor:  %an <%ae>%ndate:    %ad%nmessage: %s%n'
  sh = !git shw --no-patch
  shp = !git shw --patch

  # Branch operations
  # Lists 10 most recently modified branches
  recent = "!git for-each-ref --count=10 --sort=-committerdate refs/heads/ --format='%(refname:short)'"
  # Deletes all merged branches except main, master, develop, and staging
  purge = "!git branch --merged | grep -Ev '(\\*|master|main|develop|staging)' | xargs -r -n 1 git branch -d"

  # Commit operations
  # Squashes last N commits into one
  squash = "!f(){ git reset --soft HEAD~${1} && git commit --edit -m\"$(git log --format=%B --reverse HEAD..HEAD@{1})\" --no-verify; };f"

  # Statistics and reporting
  # Shows commit statistics (shortlog) for contributors in the last 8 weeks
  stat = "!git shortlog -sn --since='10 weeks' --until='2 weeks'"

  # Index operations
  # Marks file as unchanged in git's index (useful for local config files)
  hide = update-index --assume-unchanged
  unhide = update-index --no-assume-unchanged

  # Reset operations
  unstage = reset HEAD
  uncommit = reset --soft HEAD~1

  # Worktree operations
  wt = worktree
  # Temporarily stores changes from another worktree, resets it, and applies changes to current worktree
  wtgrab = "!f() { mktemp | xargs -I{} sh -c 'git -C $1 diff > $0; git -C $1 reset --hard HEAD; git apply $0;' {} $1; }; f"

  # Combined operations
  # Fetch, pull with rebase, and purge old branches
  u = !git f && git pur && git purge

[core]
  abbrev         = 12
  attributesfile = "~/.gitattributes"
  excludesfile   = "~/.gitignore"
  fileMode       = false
  # Treat spaces before tabs and all kinds of trailing whitespace as an error
  # [default] trailing-space: looks for spaces at the end of a line
  # [default] space-before-tab: looks for spaces before tabs at the beginning of a line
  whitespace = space-before-tab,-indent-with-non-tab,trailing-space
  # Make `git rebase` safer on macOS
  # More info: http://www.git-tower.com/blog/make-git-rebase-safe-on-osx
  trustctime = false
  # Prevent showing files whose names contain non-ASCII symbols as unversioned.
  # http://michael-kuehnel.de/git/2014/11/21/git-mac-osx-and-german-umlaute.html
  precomposeunicode = false
  # Why do we need this?
  #
  # If you check https://developer.1password.com/docs/ssh/agent/advanced#use-multiple-github-accounts
  # you will see that 1Password allows you to use multiple SSH keys for different accounts
  # by using the `IdentityFile` option in the `~/.ssh/config` file. This is a way to use
  # the same feature but for Git. This way you can use different SSH keys for different
  # repositories without changing the global `~/.ssh/config` file. The main catch is that
  # usually, you would use the private key in the `IdentityFile` option, but in this case,
  # 1Password allows you to use the public key. This is why we use the public key here.
  #
  # This solves 3 problems:
  #
  # 1. You don't have to change the global `~/.ssh/config` file to use different SSH keys
  # 2. You don't have to use the private key in the `IdentityFile` option because it is not secure.
  # 3. You can now invoke 1Password ssh key verification for Git commands not only
  # for ssh aliases as described in the 1Password documentation but also nested
  # .gitconfig architecture. Basically you can use 1Password ssh key verification
  # from different .gitconfig files in different directories without need to create
  # a separate ssh alias for each repository or directory.
  #
  # Example:
  #
  # you can find the secondary ssh key in this repos in the home/dot_ssh/secondary_public_key.pub.tmpl file
  # and it's used in home/work/private_dot_gitconfig.tmpl file
  #
  sshCommand = ssh -o IdentitiesOnly=yes -o IdentityFile="~/.ssh/primary_public_key.pub"
  # Prevent line ending issues
  autocrlf = input
  # Uses the built-in file system monitor daemon so status/add/etc. ask “what changed?” instead of walking the whole tree; complements untracked-cache that manyFiles enables; safe on local filesystems.
  fsmonitor = true

[color]
  ui = auto

[diff]
  color = auto
  # Detects renames with a threshold of 50% similarity
  renames = copies
  # Better diff algorithm that is slower but produces better results
  algorithm = histogram

[pager]
  diff = delta
  log = delta
  show = delta
  status = delta
  branch = delta
  reflog = delta

[pretty]
  custom = "%C(magenta)%h%C(red)%d %C(yellow)%ar %C(green)%s %C(yellow)(%an)"
#                     │        │            │            │             └─ author name
#                     │        │            │            └─ message
#                     │        │            └─ date (relative)
#                     │        └─ decorations (branch, heads or tags)
#                     └─ hash (abbreviated)

[pull]
  rebase = true
  ff = only

[push]
  # to avoid sitution where an existing branch with the same name is on upstream but not
  # on the origin so when you push it goes into upstream. This is a safety measure
  # to avoid that
  default = upstream
  followTags = true
  autoSetupRemote = true

[tag]
  sort = -taggerdate

[branch]
  autoSetupRebase = always
  sort = -committerdate

## GitHub
[url "git@github.com:"]
  # we don't want to use insteadOf because it breaks brew installs from brew taps
  pushInsteadOf = https://github.com/

## GitLab
[url "git@gitlab.com:"]
  # we don't want to use insteadOf because it breaks brew installs from brew taps
  pushInsteadOf = https://gitlab.com

[user]
  name = Karen Grigoryan
  email = {{ .primaryEmail }}
  signingkey = {{ .primaryPublicSshKey }}
  useConfigOnly = true

{{ if ne .isWork true }}
[includeIf "gitdir:~/work/"]
  path = ~/work/.gitconfig
{{ end }}

[gpg]
  format = ssh

[gpg "ssh"]
  program = /Applications/1Password.app/Contents/MacOS/op-ssh-sign
  allowedSignersFile = {{ joinPath .chezmoi.homeDir ".ssh" "allowed_signers" }}

[commit]
  gpgsign = true
  verbose = true

# reuse recovered resolution
# https://git-scm.com/docs/git-rerere
[rerere]
  enabled = true
  autoUpdate = true

[transfer]
  # Hide internal references that shouldn't be transferred
  hideRefs = refs/original/ refs/replace/

[fetch]
  # Hide internal references during fetch operations
  hideRefs = refs/original/ refs/replace/
  # Parallelizes object negotiation and pack download across remotes/submodules for faster fetch in big repos; tune per network/CPU.
  # 0 for reasonable default based on CPU cores
  parallel = 0
  # Writes/updates the commit-graph on fetch so subsequent log/blame/merge-base are faster; no need to run maintenance commands to benefit.
  writeCommitGraph = true

[gc]
  # Ensures the commit-graph stays present/updated when any auto-gc runs, accelerating history queries without explicit maintenance scheduling.
  writeCommitGraph = true

[submodule]
  # Parallelizes submodule fetches to keep monorepos with many submodules from serial fetch bottlenecks; independent of other settings.
  # 0 for reasonable default based on CPU cores
  fetchJobs = 0

[merge]
  autoStash = true
  # Add summary after merge
  log = true
  summary = true
  # https://www.ductile.systems/zdiff3/
  conflictStyle = zdiff3

[rebase]
  autoStash = true
  # https://andrewlock.net/smoother-rebases-with-auto-squashing-git-commits/
  autoSquash = true
  # Do not delete commits during rebase
  missingCommitsCheck = error
  # https://andrewlock.net/working-with-stacked-branches-in-git-is-easier-with-update-refs/
  updateRefs = true


[receive]
  # Hide internal references during receive operations
  hideRefs = refs/original/ refs/replace/

[log]
  date = iso
  follow = true
  decorate = short

[advice]
  detachedHead = false

[blame]
  # Show email addresses instead of names
  showEmail = true
  # Colors lines from the same commit differently
  coloring = repeatedLines

[status]
  # https://michaelheap.com/git-status-untracked/
  showUntrackedFiles = all

[checkout]
  # speed up checkout related operations on SSDs
  # see https://matheustavares.dev/posts/parallel-checkout
  workers = 0

[worktree]
  guessRemote = true

[feature]
  # https://git-scm.com/docs/git-config#Documentation/git-config.txt-featuremanyFiles
  # enables index.skipHash, index.version 4 and core.untrackedCache
  # for better performance with many files (e.g. large monorepos)
  manyFiles = true
  # enables fetch.negotiationAlgorithm=skipping (better fetch performance)
  # enables pack.useSparseBitmap (better bitmap traversal performance)
  # enables pack.allowPackReuse=multi (better pack creation performance)
  # enables pack.usePathWalk (smaller pack files)
  # enables init.defaultRefFormat=reftable (better ref storage performance)
  experimental = true

[init]
  defaultBranch = main
  defaultRefFormat = files


[filter "lfs"]
  clean = git-lfs clean -- %f
  smudge = git-lfs smudge -- %f
  process = git-lfs filter-process
  required = true

