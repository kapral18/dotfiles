#!/usr/bin/env bash
# Description: Automatically enable auto-merge for PRs targeting a specified branch

set -euo pipefail

# Source the utility library
source "$(dirname "$0")/utils/bash_utils_lib.sh"

if [ $# -lt 1 ]; then
  echo "Usage: enable_auto_merge <base_branch>"
  exit 1
fi

if ! _check_rate_limit; then
  echo "Aborting due to rate limit concerns"
  exit 1
fi

base_branch="$1"

if ! prs=$(_safe_exec_cmd gh pr list --base "$base_branch" --state open --json number --jq '.[].number'); then
  exit 1
fi

for pr_number in $prs; do
  echo "Processing PR #$pr_number..."

  if _is_auto_merge_enabled "$pr_number"; then
    echo "PR #$pr_number: Auto-merge is already enabled"
    continue
  fi

  if ! _safe_exec_cmd gh pr merge "$pr_number" --auto --squash; then
    continue
  fi

  if ! _safe_exec_cmd gh pr comment "$pr_number" --body "Auto-merge has been re-enabled. Thank you for your patience."; then
    continue
  fi

  echo "Re-enabled auto-merge for PR #$pr_number"
done
