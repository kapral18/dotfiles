#!/usr/bin/env bash

set -euo pipefail

TRIGGER_STRING="succ kbn/es setup complete"
LOGFILE="/tmp/es-main.log"

# Check if first argument is -E flag or data folder
if [[ $# -gt 0 && "$1" == "-E" ]]; then
  # First argument is -E, use default data folder
  ES_DATA_FOLDER="main-cluster"
else
  # First argument is data folder (or no arguments)
  ES_DATA_FOLDER=${1:-"main-cluster"}
  shift || true  # Remove first argument if it exists
fi

ES_DATA_PATH="$HOME/work/kibana/es_data/$ES_DATA_FOLDER"

# Build additional ES flags from remaining arguments
ES_FLAGS=""

# Handle -E key=value format
while [[ $# -gt 0 ]]; do
  if [[ "$1" == "-E" ]]; then
    if [[ $# -gt 1 ]]; then
      ES_FLAGS="$ES_FLAGS -E $2"
      shift 2
    else
      echo "Error: -E flag requires a value" >&2
      exit 1
    fi
  else
    echo "Error: Additional arguments must be in -E key=value format" >&2
    exit 1
  fi
done

# Capture current tmux session and window info
TMUX_SESSION=$(tmux display-message -p '#S')
TMUX_WINDOW=$(tmux display-message -p '#I')

yarn kbn bootstrap

(
  tail -n 0 -F "$LOGFILE" | while read -r line; do
    if [[ "$line" == *"$TRIGGER_STRING"* ]]; then
      tmux send-keys -t "${TMUX_SESSION}:${TMUX_WINDOW}.+1" "yarn start --no-base-path --host=kibana-main.local --port=5602 --elasticsearch.hosts=http://localhost:9201" C-m
      break
    fi
  done
) &

yarn es snapshot -E node.name=main -E http.port=9201 -E transport.port=9301 -E discovery.type=single-node -E path.data="$ES_DATA_PATH"${ES_FLAGS} 2>&1 | tee -a "$LOGFILE"
