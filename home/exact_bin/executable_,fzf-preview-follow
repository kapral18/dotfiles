#!/usr/bin/env python3
"""fzf preview helper that "follows" the current match.

Input:
- Prefer: `--file <path> --line <number>` (safe: avoids passing huge fzf entries via argv)
- Fallback: a single argument containing the currently selected fzf entry

Behavior:
- Extract file + line number from the entry header
- Preview a window around the line (start=line-20, end=start+240)
- Render with `bat` (highlighting the match line) and fall back to `chafa`/`hexyl`
  for images/binaries.
"""

from __future__ import annotations

import argparse
import mimetypes
import os
import re
import subprocess


RG_HEADER_RE = re.compile(r"^(.*?):(\d+):(\d+):")


def is_image(file_path: str) -> bool:
    mime_type, _ = mimetypes.guess_type(file_path)
    return mime_type is not None and mime_type.startswith("image/")


def is_binary(filepath: str) -> bool:
    with open(filepath, "rb") as f:
        data = f.read(512)
        if not data:
            return False
        null_bytes = data.count(b"\0")
        return null_bytes > 0.1 * len(data)


def parse_entry(entry: str) -> tuple[str | None, int]:
    header = entry.splitlines()[0] if entry else ""
    if "\t" in header:
        # display<TAB>file<TAB>line<TAB>col
        parts = header.split("\t")
        if len(parts) >= 3:
            file = parts[1] or None
            try:
                line = int(parts[2])
            except ValueError:
                line = 1
            return file, max(line, 1)
    m = RG_HEADER_RE.match(header)
    if m:
        file = m.group(1) or None
        try:
            line = int(m.group(2))
        except ValueError:
            line = 1
        return file, max(line, 1)
    return None, 1


def main() -> int:
    parser = argparse.ArgumentParser(
        description="fzf preview helper that follows the match line."
    )
    parser.add_argument("--file", dest="file", default=None)
    parser.add_argument("--line", dest="line", default=None)
    parser.add_argument("entry", nargs="?", default=None)
    args = parser.parse_args()

    file: str | None
    line: int

    if args.file and args.line:
        file = args.file
        try:
            line = int(args.line)
        except ValueError:
            line = 1
    elif args.entry:
        file, line = parse_entry(args.entry)
    else:
        return 0
    if not file:
        return 0

    start = max(line - 20, 1)
    end = start + 240

    if file in (".", "..") or os.path.isdir(file):
        cmd = ["ls", "-la", "--color=always", file]
    else:
        try:
            if is_image(file):
                cmd = ["chafa", "-f", "symbols", file]
            elif is_binary(file):
                cmd = ["hexyl", file]
            else:
                cmd = [
                    "bat",
                    file,
                    "--style=numbers",
                    "--color",
                    "always",
                    "--highlight-line",
                    str(line),
                    "--line-range",
                    f"{start}:{end}",
                ]
        except OSError:
            return 0

    try:
        subprocess.run(cmd, check=False)
    except Exception:
        return 0

    return 0


if __name__ == "__main__":
    raise SystemExit(main())
